(function (window) {

    /**
     *
     * @param data - site content to be injected into pug template function. This data is created
     * in custom-build-scripts.js createDataModel
     * @param templatePage - a pug template compiled into js function
     * @constructor
     */
    function ResearchController(data, templatePage) {
        console.info('ResearchController.templagePage()');
        console.info('data', data, 'templatePage', templatePage);
        this.templatePage = templatePage;
        this.data = data;
    }

    /**
     * Initialize view for reseach section
     */
    ResearchController.prototype.initView = function () {
        this._initBindings();
        // TODO: wip, uncomment when ready for production
        this._initResearchPopup();
    };

    /**
     * Sets bindings for hovering over research images on desktop
     * and tapping circle-i on touch devices
     * @private
     */
    ResearchController.prototype._initBindings = function () {
        // Assume device is non-touch screen and add hover class (could add in markup)
        $('#research .work-box').addClass('hover');

        // Listen for touch event to reset/setup DOM for touch device
        window.addEventListener('touch-device-detected', function (ev) {
            // This stops click event from registering twice
            ev.stopImmediatePropagation();
            // Undo hover effect on the research teaser
            $('#research .work-box').removeClass('hover');
            var $overlay = null;

            // TODO make whole work-box clickable - and rename to .teaser!
            $('#research').on('click', '.btn-more-info', function () {
                console.info('WHAT IS THIS?');
                $overlay = $(this).parent().children('.work-box-overlay');
                $overlay.toggleClass('show');
                // TODO: toggle .fa-info with a .fa-close
            });
        });
    };


    /**
     * Bind magificPop to research items
     */
    ResearchController.prototype._initResearchPopup = function () {

        var self = this;
        $('.research-popup').magnificPopup({
            type: 'inline',
            mainClass: 'mfp-fade',
            gallery: {
                enabled: true,
                closeOnBgClick: true,
                showCloseBtn: false
            },
            callbacks: {
                /**
                 * Parse the source of the initiating popup element
                 * @param {*} item 
                 * @type {HTMLElement} item.el
                 * @type item.index     - integer index autogenerated by magnificPopup
                 * @type {{}} item.src   - assigned within the function          
                 */
                elementParse: function (item) {
                    console.info('magificPopup callback elementParse()  item', item);
                    // Get the project data from the data-project attribute of initiator DOM element
                    var projectPageData = JSON.parse($(item.el).attr('data-project'));
                    // var projectId = projectPageData.project.id;
                    console.info('projectPageData=', projectPageData);
                    
                    // Create the page with project data
                    var dataForPopup = projectPageData.project;
                    console.log('dataForPopup', dataForPopup);
                    item.src = self.templatePage(dataForPopup);

                    // Attach close action to click event on close elemnt
                    $('#research-project').on('click', '.mfp-close', function (event) {
                        // Take user back to research section (better would be to stop magificPop scroll)
                        console.info('attaching click event');
                        event.preventDefault();
                        $.magnificPopup.close();
                        window.location.href = '#research';
                    });

                    // Attach close action to click event on researcher name
                    $('#research-project').on('click', '.researcher', function (event) {
                        // Take user back to research section (better would be to stop magificPop scroll)
                        console.info('data-id', $(this).attr('data-id'));
                        var anchor = '#' + $(this).attr('data-id');
                        document.querySelector(anchor).scrollIntoView({
                            behavior: 'smooth'
                        });
                        // $(document.body).animate({
                        //     'scrollTop':   $('#woochul').offset().top
                        // }, 2000);
                        // $(document.body).scrollTop($(anchor).offset().top);
                        event.preventDefault();
                        $.magnificPopup.close();
                    });


                }
            }
        });
    };

    // Export to window
    window.app = window.app || {};
    window.app.ResearchController = ResearchController;

})(window);



// WIP for a seperate reasearch page
// ResearchController.prototype._initBindings2 = function () {

//     console.info('ResearchController._initBindings2', this.templatePage);
//     debugger;
//     var self = this;

//     var $mainPage = $('#main-page'),
//         $researchProjectPage = $('#research-project-page');

//     // $('.research-projects').on('click', '.research-page-link', function (ev) {
//     $('#research').on('click', '.research-page-link', function (ev) {
//         var projectIndex = $(this).attr('data-project-index');
//         console.info(' clicked .research-page-link', projectIndex);
//         var projectTemplate = self.templatePage(self.data[projectIndex]);

//         var windowWidth = $(window).width(),
//             marginOffset = '-=' + 2 * $(window).width();

//         $('#main-page').animate({
//             'margin-left': marginOffset
//         });
//         $('#main-page').hide();
//         // debugger;

//         // var $researchProjectPage = $('#research-project-page');
//         var $researchProject = $('#research-project');
//         $('#research-project-page').append(projectTemplate);
//         // $researchProjectPage.css('margin-right', marginOffset);
//         $researchProject.show();
//         // $researchProjectPage.animate({
//         //     'margin-right': 0
//         // });

//         ev.preventDefault();

//     });

//     $('a.back').on('click', function (event) {
//         var windowWidth = $(window).width(),
//             marginOffset = '+=' + 2 * $(window).width();

//         $researchProjectPage.animate({
//             'margin-right': marginOffset
//         });
//         $researchProject.remove();
//         $mainPage.animate({
//             'margin-left': 0
//         });

//         window.location.hash = '#research';

//     });

// };